import{r as c,o as z,u as H,j as J,G as A,c as i,a as t,f as x,t as s,e as u,b as D,w as M,d as K,F as E,g as B,q as Q,s as X,h as r,n as F}from"./index-CanbGPVk.js";import{i as Z,a as ee,b as te,F as ne}from"./index-BXs5ZZQj.js";import{d as w}from"./DataService-z2Ih9ngB.js";import{_ as se}from"./_plugin-vue_export-helper-DlAUqK2U.js";const ae={class:"container py-4 py-lg-5"},le={class:"row"},oe={class:"col-12"},ie={class:"d-flex justify-content-between align-items-center mb-4"},re={class:"h3 mb-1"},de={key:0,class:"text-muted mb-0"},ue={key:1,class:"text-muted small mb-0"},ce={class:"d-flex gap-2"},me={key:0,class:"text-center py-5"},pe={key:1,class:"alert alert-danger",role:"alert"},ve={key:2,class:"text-center py-5"},be={key:3,class:"row g-4"},ge={class:"col-lg-4"},ye={class:"card"},fe={class:"card-body"},_e={class:"mb-2"},ke={class:"text-muted small mb-3"},he={class:"mb-3"},xe={class:"mt-2"},we=["onClick"],Ce={class:"mb-3"},Se={class:"text-muted"},Ae={class:"mb-3"},De={class:"text-primary ms-2"},Te={key:0,class:"card mt-3"},$e={class:"card-header"},Ie={class:"card-title mb-0"},Pe={class:"card-body"},Me=["onClick"],Ee={class:"col-lg-8"},Be={class:"card"},Fe={class:"card-body"},Ue={class:"card mt-3"},Ye={class:"card-body"},Ne={class:"d-flex justify-content-between align-items-center"},Re={class:"text-muted"},Ve={class:"d-flex gap-2"},je=["disabled"],Le=["disabled"],Oe={key:0,class:"spinner-border spinner-border-sm me-2"},qe={key:1,class:"bi bi-x-circle me-2"},Ge=["disabled"],We={key:0,class:"spinner-border spinner-border-sm me-2"},ze={key:1,class:"bi bi-calendar-check me-2"},He={key:4,class:"alert alert-success mt-4",role:"alert"},Je={key:5,class:"alert alert-danger mt-4",role:"alert"},Ke={__name:"MemberAppointmentPage",props:{programId:String},setup(U){const T=H(),$=X(),Y=U,o=c(null),C=c(!0),b=c(null),a=c([]),_=c(!1),k=c(!1),f=c(""),p=c(""),N=c(null),v=c(!1),S=c(null),h=c(null),I=c({plugins:[Z,ee,te],initialView:"dayGridMonth",headerToolbar:{left:"prev,next today",center:"title",right:"dayGridMonth,timeGridWeek"},events:[],selectable:!1,selectMirror:!0,dayMaxEvents:!0,weekends:!0,height:"auto",eventDisplay:"block",eventColor:"#0d6efd"});z(async()=>{const n=Y.programId||T.params.programId,e=T.query.edit;if(!n){C.value=!1;return}try{if(C.value=!0,b.value=null,o.value=await w.getProgram(n),!o.value){b.value="Program not found. Please check the program ID and try again.";return}e&&(v.value=!0,h.value=e,await O(e)),P()}catch(d){console.error("Error loading program:",d),b.value="Failed to load program details. Please try again later."}finally{C.value=!1}}),J(a,()=>{P()},{deep:!0});function P(){if(!o.value||!o.value.schedule)return;const n=[],e=new Date,d=new Date;d.setMonth(d.getMonth()+3),o.value.schedule.forEach(l=>{const g=R(l.day),m=a.value.some(W=>W.day===l.day),y=new Date(e);for(y.setDate(y.getDate()+(g-y.getDay()+7)%7);y<=d;)n.push({title:m?`${o.value.title} (Selected)`:o.value.title,start:`${y.toISOString().split("T")[0]}T${l.start}:00`,end:`${y.toISOString().split("T")[0]}T${l.end}:00`,backgroundColor:m?"#198754":"#0d6efd",borderColor:m?"#198754":"#0d6efd",extendedProps:{schedule:l,isSelected:m}}),y.setDate(y.getDate()+7)}),I.value.events=n}function R(n){return{Sunday:0,Monday:1,Tuesday:2,Wednesday:3,Thursday:4,Friday:5,Saturday:6}[n]||0}function V(n){const e=a.value.findIndex(d=>d.day===n.day);e>-1?a.value.splice(e,1):a.value.push({day:n.day,start:n.start,end:n.end,frequency:n.frequency||"weekly",startDate:n.startDate,endDate:n.endDate})}function j(n){const e=a.value.findIndex(d=>d.day===n.day);e>-1&&a.value.splice(e,1)}function L(){a.value=[]}async function O(n){try{const e=await A.getCurrentUser();if(!e.user){b.value="You must be logged in to edit appointments.";return}const l=(await w.getUserAppointments(e.user.email)).appointments.find(g=>g.id===n||g.appointment_id===n);if(!l){b.value="Appointment not found or you do not have permission to edit it.";return}if(l.program_id!==o.value.id){b.value="This appointment does not belong to the current program.";return}S.value=l,a.value=[...l.time_slot]}catch(e){console.error("Error loading existing appointment:",e),b.value="Failed to load appointment details."}}async function q(){if(a.value.length===0){p.value="Please select at least one time slot.";return}try{_.value=!0,p.value="",f.value="";const n=await A.getCurrentUser();if(!n.user){p.value="You must be logged in to book an appointment.";return}let e;if(v.value&&h.value)e=await w.updateAppointment(h.value,a.value,n.user.email),f.value=`Appointment updated successfully! Your appointment ID is ${h.value}.`;else{const d={program_id:o.value.id,user_email:n.user.email,time_slot:a.value};e=await w.createAppointment(d),f.value=`Appointment booked successfully! Your appointment ID is ${e.appointmentId}.`}a.value=[],setTimeout(()=>{$.push({name:"member-account"})},3e3)}catch(n){console.error("Error with appointment:",n),p.value=n.message||`Failed to ${v.value?"update":"book"} appointment. Please try again.`}finally{_.value=!1}}async function G(){if(!v.value||!h.value){p.value="No appointment to cancel.";return}if(confirm(`Are you sure you want to cancel this appointment for "${o.value.title}"?

This action cannot be undone. You will need to book a new appointment if you change your mind.`))try{k.value=!0,p.value="",f.value="";const e=await A.getCurrentUser();if(!e.user){p.value="You must be logged in to cancel appointments.";return}await w.cancelAppointment(h.value,e.user.email),f.value="Appointment cancelled successfully! You will be redirected to your account page.",a.value=[],S.value=null,setTimeout(()=>{$.push({name:"member-account"})},3e3)}catch(e){console.error("Error canceling appointment:",e),p.value=e.message||"Failed to cancel appointment. Please try again."}finally{k.value=!1}}return(n,e)=>{const d=K("RouterLink");return r(),i("div",ae,[t("div",le,[t("div",oe,[t("div",ie,[t("div",null,[t("h1",re,s(v.value?"Edit Your Appointment":"Book Your Appointment"),1),o.value?(r(),i("p",de,[u(s(v.value?"Editing appointment for":"Booking for")+": ",1),t("strong",null,s(o.value.title),1)])):x("",!0),v.value&&S.value?(r(),i("p",ue,[e[0]||(e[0]=t("i",{class:"bi bi-info-circle me-1"},null,-1)),u(" Current appointment: "+s(S.value.time_slot.length)+" time slot(s) selected ",1)])):x("",!0)]),t("div",ce,[D(d,{to:{name:"find"},class:"btn btn-outline-secondary"},{default:M(()=>[...e[1]||(e[1]=[t("i",{class:"bi bi-arrow-left me-2"},null,-1),u("Back to Programs ",-1)])]),_:1})])]),C.value?(r(),i("div",me,[...e[2]||(e[2]=[t("div",{class:"spinner-border text-primary",role:"status"},[t("span",{class:"visually-hidden"},"Loading program details...")],-1),t("p",{class:"mt-2 mb-0 text-muted"},"Loading program details...",-1)])])):b.value?(r(),i("div",pe,[e[3]||(e[3]=t("i",{class:"bi bi-exclamation-triangle me-2"},null,-1)),u(" "+s(b.value),1)])):o.value?(r(),i("div",be,[t("div",ge,[t("div",ye,[e[14]||(e[14]=t("div",{class:"card-header"},[t("h5",{class:"card-title mb-0"},[t("i",{class:"bi bi-info-circle me-2"}),u(" Program Details ")])],-1)),t("div",fe,[t("h6",_e,s(o.value.title),1),t("p",ke,s(o.value.description),1),t("div",he,[e[9]||(e[9]=t("strong",null,"Available Time Slots:",-1)),t("div",xe,[(r(!0),i(E,null,B(o.value.schedule,(l,g)=>(r(),i("div",{key:g,class:F(["d-flex justify-content-between align-items-center p-2 border rounded mb-2",{"bg-primary text-white":a.value.some(m=>m.day===l.day)}])},[t("div",null,[t("strong",null,s(l.day)+"s",1),e[8]||(e[8]=t("br",null,null,-1)),t("small",null,s(l.start)+" - "+s(l.end),1)]),t("button",{onClick:m=>V(l),class:F(["btn btn-sm",a.value.some(m=>m.day===l.day)?"btn-light":"btn-outline-primary"])},s(a.value.some(m=>m.day===l.day)?"Selected":"Select"),11,we)],2))),128))])]),t("div",Ce,[e[11]||(e[11]=t("strong",null,"Venue:",-1)),e[12]||(e[12]=t("br",null,null,-1)),t("small",Se,[u(s(o.value.venue?.name),1),e[10]||(e[10]=t("br",null,null,-1)),u(" "+s(o.value.venue?.address)+", "+s(o.value.venue?.suburb),1)])]),t("div",Ae,[e[13]||(e[13]=t("strong",null,"Cost:",-1)),t("span",De,s(o.value.cost===0?"Free":`$${o.value.cost} ${o.value.costUnit}`),1)])])]),a.value.length>0?(r(),i("div",Te,[t("div",$e,[t("h6",Ie,[e[15]||(e[15]=t("i",{class:"bi bi-check-circle me-2"},null,-1)),u(" Selected Time Slots ("+s(a.value.length)+") ",1)])]),t("div",Pe,[(r(!0),i(E,null,B(a.value,(l,g)=>(r(),i("div",{key:g,class:"d-flex justify-content-between align-items-center p-2 bg-light rounded mb-2"},[t("div",null,[t("strong",null,s(l.day)+"s",1),e[16]||(e[16]=t("br",null,null,-1)),t("small",null,s(l.start)+" - "+s(l.end),1)]),t("button",{onClick:m=>j(l),class:"btn btn-sm btn-outline-danger"},[...e[17]||(e[17]=[t("i",{class:"bi bi-x"},null,-1)])],8,Me)]))),128))])])):x("",!0)]),t("div",Ee,[t("div",Be,[e[18]||(e[18]=t("div",{class:"card-header"},[t("h5",{class:"card-title mb-0"},[t("i",{class:"bi bi-calendar me-2"}),u(" Calendar View ")])],-1)),t("div",Fe,[D(Q(ne),{ref_key:"calendarRef",ref:N,options:I.value},null,8,["options"])])]),t("div",Ue,[t("div",Ye,[t("div",Ne,[t("div",null,[e[19]||(e[19]=t("h6",{class:"mb-1"},"Ready to Book?",-1)),t("small",Re,s(a.value.length)+" time slot(s) selected ",1)]),t("div",Ve,[t("button",{onClick:L,class:"btn btn-outline-secondary",disabled:a.value.length===0}," Clear Selection ",8,je),v.value?(r(),i("button",{key:0,onClick:G,class:"btn btn-outline-danger",disabled:k.value||_.value},[k.value?(r(),i("span",Oe)):(r(),i("i",qe)),u(" "+s(k.value?"Canceling...":"Cancel Appointment"),1)],8,Le)):x("",!0),t("button",{onClick:q,class:"btn btn-success",disabled:a.value.length===0||_.value||k.value},[_.value?(r(),i("span",We)):(r(),i("i",ze)),u(" "+s(_.value?v.value?"Updating...":"Booking...":v.value?"Update Appointment":"Book Appointment"),1)],8,Ge)])])])])])])):(r(),i("div",ve,[e[5]||(e[5]=t("i",{class:"bi bi-calendar-x display-1 text-muted mb-4"},null,-1)),e[6]||(e[6]=t("h4",{class:"mb-3"},"No Program Selected",-1)),e[7]||(e[7]=t("p",{class:"text-muted mb-4"}," Please select a program from the programs list to book an appointment. ",-1)),D(d,{to:{name:"find"},class:"btn btn-primary"},{default:M(()=>[...e[4]||(e[4]=[t("i",{class:"bi bi-search me-2"},null,-1),u("Browse Programs ",-1)])]),_:1})])),f.value?(r(),i("div",He,[e[20]||(e[20]=t("i",{class:"bi bi-check-circle-fill me-2"},null,-1)),u(" "+s(f.value),1)])):x("",!0),p.value?(r(),i("div",Je,[e[21]||(e[21]=t("i",{class:"bi bi-exclamation-triangle-fill me-2"},null,-1)),u(" "+s(p.value),1)])):x("",!0)])])])}}},tt=se(Ke,[["__scopeId","data-v-30f885df"]]);export{tt as default};
